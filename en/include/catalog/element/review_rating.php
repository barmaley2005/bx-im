<?
\Bitrix\Main\Loader::includeModule('devbx.forms');

$form = \DevBx\Forms\FormManager::getInstance()->getFormInstance(2);

$arFilter = [
    '=ACTIVE' => 'Y',
    '=UF_PRODUCT_ID' => $arResult['ID'],
];

$row = $form->getDataClass()::getList([
    'filter' => $arFilter,
    'runtime' => [
        new \Bitrix\Main\ORM\Fields\ExpressionField('AVG_RATING', 'avg(%s)', ['UF_RATING'])
    ],
    'select' => [
        'AVG_RATING'
    ],
])->fetch();

$query = $form->getDataClass()::query();
$query->setFilter($arFilter);
$reviewCnt = $query->queryCountTotal();

$avgRating = $row ? ceil($row['AVG_RATING']) : 0;


?>
<div class="accordeon-header__star">
    <?
    for ($i=1;$i<=5;$i++)
    {
        $fillColor = $avgRating>=$i ? '#877569' : '#E6E2D9';
        ?>
        <svg width="26" height="25" viewBox="0 0 26 25" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd"
                  d="M20.0401 23.547C19.6583 23.7422 19.217 23.7477 18.7921 23.4435L13.6019 19.6937C13.3761 19.5526 13.1981 19.4921 13.0146 19.4921C12.8035 19.4921 12.6081 19.5342 12.3649 19.635L7.23889 23.3738C6.83237 23.712 6.38456 23.7065 5.98355 23.5214C5.94933 23.5057 5.91567 23.4889 5.88261 23.471C5.80565 23.4331 5.73581 23.3822 5.67614 23.3207C5.71927 23.3647 5.61557 23.2712 5.5495 23.1924C5.41507 23.0399 5.32494 22.8536 5.28887 22.6536C5.2528 22.4537 5.27217 22.2477 5.34487 22.0579L7.35543 15.9036C7.4165 15.7238 7.41769 15.5291 7.35881 15.3486C7.29993 15.168 7.18414 15.0114 7.02875 14.902L1.82569 11.1027C1.61333 10.9637 1.45242 10.7591 1.36757 10.5201C1.28272 10.2812 1.27861 10.021 1.35585 9.7795C1.45771 9.30848 1.92479 8.91078 2.51392 8.91078H9.00353C9.38252 8.91078 9.73765 8.65053 9.86704 8.28307L11.8648 2.17181C12.0364 1.567 12.542 1.31592 13.0155 1.31592C13.2348 1.31592 13.4211 1.34891 13.6432 1.48361C13.8698 1.6229 14.0433 1.83825 14.158 2.1434L16.1584 8.26657C16.2933 8.65053 16.6485 8.91078 17.0274 8.91078H23.4767C23.8924 8.91078 24.2246 9.09588 24.4375 9.39095C24.4925 9.46793 24.5375 9.54857 24.5623 9.60172C24.832 10.0416 24.7072 10.7197 24.1924 11.0844L18.9646 14.902C18.8071 15.0136 18.6904 15.1735 18.6322 15.3575C18.5741 15.5414 18.5777 15.7393 18.6425 15.921L20.6246 22.0359C20.8907 22.6581 20.5824 23.273 20.1199 23.503C20.094 23.5189 20.0674 23.5336 20.0401 23.547Z"
                  fill="<?=$fillColor?>" />
        </svg>
        <?
    }
    ?>
</div>
<p class="accordeon-header__count"><?=$reviewCnt?> отзывов</p>
